# =============================================================================
# EoMT Base 640 - Integrazione Totale: LoRA + ArcFace + LogitNorm + CutPaste
# =============================================================================

trainer:
  max_epochs: 107
  callbacks:
    - class_path: lightning.pytorch.callbacks.ModelCheckpoint
      init_args:
        every_n_epochs: 1
        save_last: true
  logger:
    class_path: lightning.pytorch.loggers.wandb.WandbLogger
    init_args:
      resume: allow
      project: "eomt"
      name: "cityscapes_semantic_eomt_base_640_COMBINED"

model:
  # Utilizziamo la classe semantic che gestisce i logit
  class_path: training.mask_classification_semantic_combined.MaskClassificationSemantic
  init_args:
    img_size: [640, 640]
    num_classes: 20  # 19 Cityscapes + 1 Anomalia (CutPaste)
    
    # Annealing per la mask attention (stabilità training)
    attn_mask_annealing_enabled: True
    attn_mask_annealing_start_steps: [3317, 8292, 13268]
    attn_mask_annealing_end_steps: [6634, 11609, 16585]
    
    # IMPORTANTE: Reinizializziamo la testa perché passiamo da 19 a 20 classi
    load_ckpt_class_head: false
    
    # Configurazione della Criterion (Loss)
    # Nota: Assicurati di puntare al file python che implementa ArcFace + LogitNorm
    # Se hai creato un file ibrido, cambia il class_path qui sotto.
    criterion:
      class_path: training.mask_classification_loss_arcFace.MaskClassificationLoss
      init_args:
        num_labels: 20              # <--- QUESTO RISOLVE L'ERRORE (19 classi + 1 anomalia)
        num_points: 12544           # Obbligatorio
        oversample_ratio: 3.0       # Obbligatorio
        importance_sample_ratio: 0.75 # Obbligatorio
        mask_coefficient: 5.0       # Obbligatorio
        dice_coefficient: 5.0       # Obbligatorio
        class_coefficient: 2.0      # Obbligatorio
        no_object_coefficient: 0.1  # Obbligatorio
        arcface_s: 30.0             # Parametro specifico ArcFace
        arcface_m: 0.50             # Parametro specifico ArcFace
    ckpt_path: /teamspace/studios/this_studio/AnomalySegmentation/eomt/6w549yeo/checkpoints/epoch=0-step=1487_lora.ckpt

    network:
      class_path: models.eomt.EoMT
      init_args:
        num_q: 100
        num_blocks: 3
        num_classes: 20
        encoder:
          class_path: models.vit.ViT
          init_args:
            img_size: [640, 640]
            backbone_name: vit_base_patch14_reg4_dinov2
            patch_size: 16
        # Integrazione LoRA
        lora_config:
          class_path: models.lora_integration.LoRAConfig
          init_args:
            enabled: true
            rank: 8
            lora_alpha: 16
            lora_dropout: 0.1
            target_modules: ["qkv", "proj", "fc1", "fc2"] 
            freeze_base_model: true

data:
  # Utilizziamo il datamodule CutPaste
  class_path: datasets.cityscapes_semantic_cutpaste.CityscapesSemanticCutPaste
  init_args:
    path: "/teamspace/studios/this_studio/cityscapes_cutpaste"
    original_cityscapes_path: "/teamspace/studios/this_studio/datasets"
    num_workers: 4
    batch_size: 2
    img_size: [640, 640]
    num_classes: 20
    color_jitter_enabled: true
    scale_range: [0.5, 2.0]