# =============================================================================
# EoMT Base 640 Configuration for Cut-Paste Anomaly Segmentation Training
# =============================================================================
#
# This config is used for fine-tuning EoMT on Cityscapes with synthetic anomalies
# generated via Cut-Paste augmentation. The model learns to segment both standard
# Cityscapes classes (0-18) and the anomaly class (19).
#
# Key differences from standard config:
#   - num_classes: 20 (19 Cityscapes + 1 anomaly)
#   - load_ckpt_class_head: false (reinitialize classifier for new class count)
#   - Uses CityscapesSemanticCutPaste DataModule
# =============================================================================

trainer:
  max_epochs: 107
  logger:
    class_path: lightning.pytorch.loggers.wandb.WandbLogger
    init_args:
      resume: allow
      project: "eomt"
      name: "cityscapes_semantic_eomt_base_640_cutpaste"

model:
  class_path: training.mask_classification_semantic.MaskClassificationSemantic
  init_args:
    # Image size and number of classes
    img_size: [640, 640]
    num_classes: 20  # 19 Cityscapes + 1 anomaly (class_head will have 21 cols with +1 no-object)
    
    # Attention mask annealing schedule for progressive training
    attn_mask_annealing_enabled: True
    attn_mask_annealing_start_steps: [3317, 8292, 13268]
    attn_mask_annealing_end_steps: [6634, 11609, 16585]
    
    # Skip loading class_head from checkpoint (will be reinitialized for 21 classes)
    # This is required because we changed num_classes from 19 to 20
    load_ckpt_class_head: false
    
    network:
      class_path: models.eomt.EoMT
      init_args:
        num_q: 100              # Number of query tokens
        num_blocks: 3           # Number of decoder blocks
        num_classes: 20         # Must match model.num_classes
        encoder:
          class_path: models.vit.ViT
          init_args:
            backbone_name: vit_base_patch14_reg4_dinov2  # DINOv2 backbone

data:
  class_path: datasets.cityscapes_semantic_cutpaste.CityscapesSemanticCutPaste
  init_args:
    # Path to pre-generated dataset with Cut-Paste applied
    path: "/teamspace/studios/this_studio/cityscapes_cutpaste"
    
    # Path to original Cityscapes zip files (used for validation)
    original_cityscapes_path: "/teamspace/studios/this_studio/datasets"
    
    # DataLoader parameters
    num_workers: 4
    batch_size: 2
    img_size: [640, 640]        # Training resolution
    num_classes: 20             # 19 Cityscapes + 1 anomaly
    color_jitter_enabled: true  # Enable color augmentation
    scale_range: [0.5, 2.0]     # Random scale range for training
